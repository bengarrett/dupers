# https://taskfile.dev

# This Task file uses relative paths and expects to be located in the root of the dupers repository.
version: '3'

vars:
  FILE: ./test/files_to_check/qziD6WMRvPyk
  USERDST: "{{.USER_WORKING_DIR}}/.task"
  DST: ./.task/
  DST2: ./task-number-2/
  DST3: ./task-number-three/
  TEST: ./test/
  TMP: ./test/randomfiles.*
  CHK: ./test/files_to_check/*
  B1: ./test/bucket1/*
  B2: ./test/bucket2/*
  RUNRACE: run -race main.go -debug

tasks:
  race:
    silent: true
    cmds:
      - go build -v -race -o dupers main.go
  errs:
    silent: true
    cmds:
      - echo -e "## Testing failures"
      - go {{.RUNRACE}} invalid-command
      - go {{.RUNRACE}} invalid-command and-more-args
  flags:
    silent: true
    cmds:
      - echo -e "## Testing help.\n"
      - go run -race main.go
      - echo -e "## Testing -mono.\n"
      - go {{.RUNRACE}} -mono
      - echo -e "## Testing database help"
      - go {{.RUNRACE}} -h database
      - echo -e "## Testing search help"
      - go {{.RUNRACE}} search --help
      - echo -e "## Testing dupe help"
      - go {{.RUNRACE}} -help dupe
      - echo -e "## Testing -version.\n"
      - go {{.RUNRACE}} -version
      - echo -e "## Testing -mono -version.\n"
      - go {{.RUNRACE}} -mono -version      
      - echo -e "## Testing -mono -version -quiet.\n"
      - go {{.RUNRACE}} -mono -version -quiet
      - echo -e "## Testing -mvq.\n"
      - go {{.RUNRACE}} -m -v -q
      - echo -e "## Database"
      - go {{.RUNRACE}} database
      - echo -e "## DB -d -m"
      - go {{.RUNRACE}} db -d -m
      - echo -e "## Debug aliases"
      - go {{.RUNRACE}} -m -q -d -v -h -e -n -f
      - echo -e "## Debug flag"
      - go {{.RUNRACE}} -mono -quiet -debug -version -help -exact -name -fast -delete -delete+ -sensen
  makeTmp:
    silent: false
    cmds:
      - cmd:
          mkdir --verbose {{.DST}}
        ignore_error: true
      - cmd:
          cp --no-clobber --no-dereference {{.CHK}} {{.DST}}
          cp --no-clobber --no-dereference {{.TMP}} {{.DST}}
          cp --no-clobber --no-dereference {{.B1}} {{.DST}}
          cp --no-clobber --no-dereference {{.B2}} {{.DST}}
        ignore_error: true
  removeTmp:
    silent: false
    cmds:
      - cmd:
         rm --force --recursive --verbose {{.DST}}
        ignore_error: true
  cloneTmp:
    silent: false
    cmds:
      - cmd:
         cp --no-clobber --no-dereference {{.FILE}} {{.DST}}/random-duplicate-file.tmp
      - cmd:
         cp --no-clobber --no-dereference {{.FILE}} {{.DST}}/random_duplicate#fileüìÅwith+unicode.tmp
      # - cmd:
      #    go {{.RUNRACE}} up {{.DST}} # TODO fails

  dupeFile:
    silent: false
    cmds:
      - cmd:
         go {{.RUNRACE}} dupe {{.FILE}} {{.DST}}
      - cmd:
         go {{.RUNRACE}} -fast dupe {{.FILE}} {{.DST}}
  dupeCmds:
    silent: false
    cmds:
      # - cmd:
      #    go {{.RUNRACE}} -yes dupe {{.TEST}} {{.USERDST}}
      # - cmd:
      #    go {{.RUNRACE}} -yes -fast dupe {{.TEST}} {{.USERDST}}/
      # - cmd:
      #    go {{.RUNRACE}} -yes dupe {{.TEST}} {{.DST}}
      # - cmd:
      #    go {{.RUNRACE}} dupe {{.TEST}}xx {{.DST}}
      #   ignore_error: true # the cmds with ignore_error should always fail
      # - cmd:
      #    go {{.RUNRACE}} -fast dupe xx{{.TEST}} {{.DST}}
      #   ignore_error: true
      # - cmd:
      #    go {{.RUNRACE}} -yes dupe {{.TEST}} {{.DST2}} {{.DST3}}
      #   ignore_error: true
      # - cmd:
      #    go {{.RUNRACE}} -yes dupe {{.TEST}} {{.DST2}} {{.DST3}} {{.DST}}
      #   ignore_error: true
      # - cmd:
      #    go {{.RUNRACE}} -yes dupe {{.TEST}} {{.DST}} {{.DST2}} {{.DST3}}
      #   ignore_error: true
      - cmd:
         go {{.RUNRACE}} -yes dupe {{.DST}} # this scans all buckets, maybe make a note or a prompt? or change behavior
         # THIS SHOULD NOT BE running debug
      - task: cloneTmp
      - cmd:
         go {{.RUNRACE}} -yes dupe {{.DST}}  # this is also returning debug info, clean is only in READONLY mode
      - cmd:
         go {{.RUNRACE}} -yes -fast dupe {{.DST}}
      # TODO commands -fast, -delete -delete+ -sensen flags

  searchCmds:
    silent: false
    cmds:
      - cmd:
         go {{.RUNRACE}} -yes search
        ignore_error: true
      - cmd:
         go {{.RUNRACE}} -yes search asinglelineoftextwithoutspaces 
      - cmd:
         go {{.RUNRACE}} -yes search 'a single line of text with spaces'
      - cmd:
         go {{.RUNRACE}} -yes search "a single line of text with spaces"
      - task: cloneTmp
      - cmd:
         go {{.RUNRACE}} -yes search with+unicode
      - cmd:
         go {{.RUNRACE}} -yes search "with+unicode"
      - cmd:
         go {{.RUNRACE}} -yes search "WiTh+UnIcOdE"
      - cmd:
         go {{.RUNRACE}} -yes search fileüìÅwith # move emoji to .task/
      - cmd:
         go {{.RUNRACE}} -yes -name search fileüìÅwith
      - cmd:
         go {{.RUNRACE}} -yes -name -exact search fileüìÅwith
      - cmd:
         go {{.RUNRACE}} -yes search ".task"
      - cmd:
         go {{.RUNRACE}} -yes -name search ".task"
      - cmd:
         go {{.RUNRACE}} -yes -exact search ".TASK"
      - cmd:
         go {{.RUNRACE}} -yes search ".TASK"
      - cmd:
         go {{.RUNRACE}} -yes search ".7Z"

  databaseCmds:
    silent: false
    cmds:
      - cmd:
         go {{.RUNRACE}} db
      - cmd: # cleanup
         go {{.RUNRACE}} -yes rm {{.USERDST}}
        ignore_error: true
      - cmd: # up
         go {{.RUNRACE}} up {{.USERDST}}
      - cmd:
         go {{.RUNRACE}} -yes rm {{.USERDST}}
      - cmd: # double-up and ls
         go {{.RUNRACE}} up {{.USERDST}}
      - cmd:
         go {{.RUNRACE}} up {{.USERDST}}
      - cmd:
         go {{.RUNRACE}} ls {{.USERDST}}
      - cmd: # cleanup
         go {{.RUNRACE}} -yes rm {{.USERDST}}

      # todo: backup, up+, ls , export, rm, ls, import, ls, rm
      # todo: backup, clean, etc

      # - cmd:
      #    go {{.RUNRACE}} rm {{.USERDST}}
  exportCmds:
    silent: false
    cmds:
      - cmd:
         go {{.RUNRACE}} db
      # - cmd:
      #    go {{.RUNRACE}} backup
      - cmd:
         go {{.RUNRACE}} export # no feedback
        ignore_error: true
      - cmd:
         go {{.RUNRACE}} export thisisaninvaliddatabasebucket
        ignore_error: true
      - cmd:
         go {{.RUNRACE}} export thisisaninvaliddatabasebucket thisisaninvaliddatabasebucket_1
        ignore_error: true
      - cmd:
         go {{.RUNRACE}} up {{.USERDST}}
      - cmd:
         # TODO: create the ability to export to a supplied path, so we can test importing
         go {{.RUNRACE}} -quiet export {{.USERDST}}
      - cmd:
         go {{.RUNRACE}} mv
        ignore_error: true
      - cmd:
         go {{.RUNRACE}} mv {{.USERDST}}
        ignore_error: true
      - cmd:
         go {{.RUNRACE}} mv thisisaninvaliddatabasebucket thisisaninvaliddatabasebucket_1
        ignore_error: true
      - cmd:
         go {{.RUNRACE}} mv {{.USERDST}} {{.USERDST}}
        ignore_error: true
      - cmd:
         go {{.RUNRACE}} -yes mv {{.USERDST}} {{.USERDST}}üìÅzxcv
      - cmd:
         go {{.RUNRACE}} db
      - cmd:
         go {{.RUNRACE}} -yes rm {{.USERDST}}üìÅzxcv

  one:
    silent: false
    cmds:
      - task: makeTmp
      - task: exportCmds
      #- task: databaseCmds
      #- task: dupeFile
      #- task: dupeCmds
      #- task: searchCmds
      #- task: removeTmp
  lint:
    silent: false
    cmds:
      - cmd: gofumpt -w .
      - cmd: golangci-lint run
  
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 
# 