# https://taskfile.dev
#
# Clean, simplified Taskfile for dupers
# Focuses on essential development and testing workflows
version: '3'

vars:
  FILE: ./testdata/files_to_check/qziD6WMRvPyk
  TEST_DIR: ./.task_test
  TEST_DATA: ./testdata/
  RUNRACE: run -race main.go

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list-all

  # ===== Development Tasks =====

  lint:
    desc: Format and lint code
    cmds:
      - gci write ./..
      - gofumpt -w .
      - golangci-lint run

  test:
    desc: Run all tests
    cmds:
      - go test ./...
  
  test-cover:
    desc: Run all tests with coverage
    cmds:
      - go test -cover ./...

  test-race:
    desc: Run tests with race detector
    cmds:
      - go test -race ./...

  fuzz:
    desc: Run fuzz tests (30s each)
    cmds:
      - go test -fuzz=FuzzChecksum -fuzztime=30s ./pkg/dupe/parse
      - go test -fuzz=FuzzExtension -fuzztime=30s ./pkg/dupe/internal/archive
      - go test -fuzz=FuzzMIME -fuzztime=30s ./pkg/dupe/internal/archive
      - go test -fuzz=FuzzWindowsChk -fuzztime=30s ./pkg/cmd
      - go test -fuzz=FuzzSearchSummary -fuzztime=30s ./pkg/cmd

  fuzz-continuous:
    desc: Run fuzz tests continuously
    cmds:
      - go test -fuzz=FuzzChecksum ./pkg/dupe/parse
      - go test -fuzz=FuzzExtension ./pkg/dupe/internal/archive
      - go test -fuzz=FuzzMIME ./pkg/dupe/internal/archive
      - go test -fuzz=FuzzWindowsChk ./pkg/cmd
      - go test -fuzz=FuzzSearchSummary ./pkg/cmd

  # ===== Database Tasks =====

  db-info:
    desc: Show database information
    cmds:
      - go {{.RUNRACE}} db

  db-backup:
    desc: Create database backup
    cmds:
      - go {{.RUNRACE}} backup

  db-clean:
    desc: Clean stale database entries
    cmds:
      - go {{.RUNRACE}} clean

  # ===== Duplicate Detection Tasks =====

  dupe-file:
    desc: Test duplicate file detection
    cmds:
      - go {{.RUNRACE}} dupe {{.FILE}} {{.TEST_DATA}}

  dupe-dir:
    desc: Test duplicate directory detection
    cmds:
      - go {{.RUNRACE}} dupe {{.TEST_DATA}} {{.TEST_DATA}}

  # ===== Search Tasks =====

  search:
    desc: Test search functionality
    cmds:
      - go {{.RUNRACE}} search "test" {{.TEST_DATA}}

  # ===== Setup/Cleanup Tasks =====

  setup-test:
    desc: Setup test environment
    cmds:
      - mkdir -p {{.TEST_DIR}}
      - cp -r {{.TEST_DATA}}* {{.TEST_DIR}}/

  cleanup-test:
    desc: Cleanup test environment
    cmds:
      - rm -rf {{.TEST_DIR}}

  # ===== Build/Release Tasks =====

  build:
    desc: Build the application
    cmds:
      - go build -o dupers .

  release-snapshot:
    desc: Create release snapshot
    cmds:
      - goreleaser release --snapshot --clean

  # ===== Documentation Tasks =====

  docs:
    desc: Generate documentation
    cmds:
      - pkgsite -http localhost:8090
